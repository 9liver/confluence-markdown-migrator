################################################################################
# Confluence to Markdown Migration Tool - Configuration Example
################################################################################
#
# Copy this file to 'config.yaml' and fill in your credentials and settings.
# Environment variable substitution is supported using syntax: ${VARIABLE_NAME}
# For sensitive values, use environment variables rather than hardcoding.
#
################################################################################

# Confluence source connection settings
confluence:
  # Confluence Server/Cloud URL (required)
  base_url: "https://confluence.example.com"
  
  # Authentication type: "basic" or "bearer" (default: "basic")
  # - "basic": Username/password authentication
  # - "bearer": API token authentication (for Confluence Cloud)
  auth_type: "basic"
  
  # Basic authentication credentials (required if auth_type is "basic")
  username: "your-confluence-username"
  password: ${CONFLUENCE_PASSWORD}  # Use environment variable
  
  # API token for bearer authentication (required if auth_type is "bearer")
  # api_token: ${CONFLUENCE_API_TOKEN}
  
  # SSL verification (default: true)
  verify_ssl: true
  
  # Path to HTML export directory (required if migration.mode is "html")
  # Comment out if using API mode
  # html_export_path: "./confluence-export-html"


# Wiki.js target settings (required if using Wiki.js export target)
wikijs:
  # Wiki.js instance URL
  base_url: "https://wiki.example.com"
  
  # API key from Wiki.js admin panel (Administration > API)
  # Generate at: ${WIKIJS_BASE_URL}/a/admin/api
  api_key: ${WIKIJS_API_KEY}
  
  # SSL verification (default: true)
  verify_ssl: true
  
  # Default locale for created pages (default: "en")
  default_locale: "en"
  
  # Default editor type (default: "markdown")
  default_editor: "markdown"
  
  # Conflict resolution strategy for existing pages
  conflict_resolution: 'skip'  # Options: 'skip' (ignore conflicts), 'overwrite' (replace content), 'version' (append -2, -3 suffixes)
  
  # Preserve Confluence labels as Wiki.js tags
  preserve_labels: true
  
  # Include space key in generated paths (default: true)
  include_space_in_path: true  # true: /SPACE/parent/child (preserves isolation); false: /parent/child (flat structure)
  
  # Attachment upload settings
  asset_upload:
    enabled: true              # Enable/disable attachment uploads to Wiki.js assets
    folder: '/confluence-assets'  # Target folder path in Wiki.js (must start with /)
    max_workers: 3             # Number of parallel upload threads
    rewrite_links: true        # Replace local attachment paths with asset URLs in markdown


# BookStack target settings (required if using BookStack export target)
bookstack:
  # BookStack instance URL
  base_url: "https://bookstack.example.com"
  
  # API token credentials (Settings > API Tokens)
  # Generate API tokens in BookStack admin panel
  token_id: ${BOOKSTACK_TOKEN_ID}
  token_secret: ${BOOKSTACK_TOKEN_SECRET}
  
  # SSL verification (default: true)
  verify_ssl: true


# Migration execution settings
migration:
  # Fetch mode: "api" or "html" (default: "api")
  # - "api": Fetch via Confluence REST API
  # - "html": Parse from Confluence HTML export files
  mode: "api"

  # Migration workflow mode (default: "export_only")
  # Options:
  #   - "export_only": Fetch from Confluence, convert, export to markdown files
  #   - "import_only": Fetch from Confluence, convert, import directly to wiki (no local files)
  #   - "export_then_import": Fetch, convert, export to files, then import to wiki
  #   - "import_from_markdown": Read local markdown files and import to wiki (no Confluence fetch)
  #
  # Example workflows:
  #   1. First export: python migrate.py --workflow export_only
  #   2. Then import: python migrate.py --workflow import_from_markdown --export-target wikijs
  workflow: "export_only"

  # Export target destination (default: "markdown_files")
  # Options:
  #   - "markdown_files": Export to local markdown files only
  #   - "wikijs": Import directly to Wiki.js
  #   - "bookstack": Import directly to BookStack
  #   - "both_wikis": Import to both Wiki.js and BookStack
  #
  # Note: import_from_markdown workflow requires wiki target (wikijs, bookstack, or both_wikis)
  export_target: "markdown_files"
  
  # Optional: List of space keys to migrate (empty = all spaces)
  spaces: []
  # Example: spaces: ["DEV", "OPS", "DOC"]
  
  # Optional: Single page ID to migrate (useful for testing)
  page_id: null
  
  # Optional: Filter pages modified after this date (ISO format)
  since_date: null
  # Example: since_date: "2023-01-01T00:00:00Z"
  
  # Perform dry run without making changes (default: false)
  dry_run: false
  
  # Enable interactive TUI mode for space/page selection (default: false)
  interactive: false
  
  # Number of pages to process in parallel (default: 5)
  batch_size: 5
  
  # Store Confluence page IDs as tags/metadata (default: true)
  preserve_page_ids: true


# Export settings for markdown files mode
export:
  # Output directory for exported markdown files (default: "./confluence-export")
  # This directory is also used by import_from_markdown workflow to read files
  output_directory: "./confluence-export"

  # Markdown files include comprehensive YAML frontmatter with:
  # - Confluence page ID, title, space info
  # - Parent chain and hierarchy depth for reconstruction
  # - Attachment metadata with checksums
  # - Conversion status and warnings
  # - Content checksums for integrity verification
  # This enables import_from_markdown workflow to work independently

  # Markdown flavor for conversion (default: "gfm")
  # Options:
  #   - "commonmark": Standard CommonMark
  #   - "gfm": GitHub Flavored Markdown
  #   - "wikijs": Wiki.js compatible markdown
  markdown_flavor: "gfm"
  
  # Generate README.md index files in directories (default: true)
  create_index_files: true
  
  # Create subdirectories for each Confluence space (default: true)
  organize_by_space: true
  
  # Attachment handling configuration
  attachment_handling:
    # Download attachments from Confluence (default: true)
    download_attachments: true
    
    # Maximum attachment file size in bytes (default: 52428800 = 50MB)
    max_file_size: 52428800
    
    # File extensions to skip (e.g., executables, archives)
    skip_file_types:
      - ".exe"
      - ".dll"
      - ".zip"
      - ".tar"
      - ".gz"
      - ".rar"
    
    # Subdirectory name for attachments (default: "attachments")
    attachment_directory: "attachments"
    
    # Enable tqdm progress bars for attachment downloads (default: true)
    progress_bars: true


# Content processing settings
content_processing:
  # Confluence macro conversion settings
  macro_conversion:
    # Enable macro to markdown conversion (default: true)
    enabled: true
    
    # Use raw macro content as fallback if conversion fails (default: true)
    fallback_to_raw: true
    
    # List of macro types to attempt conversion (default: common macros)
    supported_macros:
      - "info"
      - "note"
      - "tip"
      - "warning"
      - "code"
      - "expand"
      - "panel"
      - "toc"
      - "children"
      - "anchor"
      - "jira"
  
  # Link handling settings
  link_handling:
    # Resolve internal Confluence links to markdown links (default: true)
    resolve_internal_links: true
    
    # Preserve anchor links within pages (default: true)
    preserve_anchors: true
    
    # Convert @user mentions to text (default: false)
    convert_user_mentions: false
  
  # Image handling settings
  image_handling:
    # Embed images in markdown with proper references (default: true)
    embed_images: true
    
    # Preserve alt text from Confluence (default: true)
    preserve_alt_text: true
    
    # Optional: Maximum image width in pixels (null = no limit)
    max_image_width: null


# Logging configuration
logging:
  # Log level: DEBUG, INFO, WARNING, ERROR, CRITICAL (default: "INFO")
  # Note: CLI --verbose flags override this setting
  level: "INFO"
  
  # Optional: Path to log file (default: null = no file logging)
  file: null
  # Example: file: "./migration.log"
  
  # Log message format (optional)
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  
  # Date format (optional)
  date_format: "%Y-%m-%d %H:%M:%S"


# Advanced settings (normally not required to change)
advanced:
  # HTTP request timeout in seconds (default: 30)
  request_timeout: 30
  
  # Maximum retry attempts for failed requests (default: 3)
  max_retries: 3
  
  # Exponential backoff factor for retries (default: 2)
  retry_backoff_factor: 2
  
  # Minimum seconds between requests (default: 0.0)
  rate_limit: 0.0
  
  # Caching configuration for minimizing API calls and runtime
  cache:
    # Enable caching of fetched content (default: false)
    enabled: false
    
    # Cache mode: "disable", "always_use", "validate" (default: "validate")
    # - "disable": No caching, always fetch fresh from API
    # - "always_use": Use cached data even if expired (offline mode)
    # - "validate": Check with Confluence if cached data is still valid (smart mode)
    mode: "validate"
    
    # Cache directory path (default: "./.cache")
    directory: "./.cache"
    
    # Cache TTL in seconds - how long to keep cached data (default: 86400 = 1 day)
    ttl_seconds: 86400
    
    # Validate cache against Confluence using ETag/Last-Modified headers (default: true)
    # Only applies when mode is "validate"
    validate_with_headers: true
    
    # Cache attachments (binary files) in addition to API responses (default: true)
    cache_attachments: true
    
    # Verify attachment checksums on cache retrieval (default: true)
    verify_checksums: true
  
  # Cache Modes Explained:
  # - "validate": Recommended for most use cases. Checks with Confluence API if cached
  #   content is still current using HTTP cache headers (ETag, Last-Modified). Only
  #   downloads full content if changed. Minimizes API calls while ensuring freshness.
  # - "always_use": Offline mode. Uses cached data without validation, even if expired.
  #   Useful for working without network access or testing. May use stale data.
  # - "disable": Always fetches fresh data from API. Use when cache is causing issues
  #   or when you need guaranteed latest content. Slowest but most reliable.
  
  # Legacy cache settings (deprecated, use cache section above)
  # cache_enabled: false  # Replaced by cache.enabled
  # cache_directory: "./.cache"  # Replaced by cache.directory
  # cache_ttl_seconds: 86400  # Replaced by cache.ttl_seconds
  
  # Integrity Verification:
  # This feature performs comprehensive validation of fetched Confluence content to ensure
  # completeness and correctness before conversion. It checks:
  # - All referenced attachments/images are downloaded
  # - Page hierarchy has no orphans or circular references
  # - Internal links point to valid pages
  # - Content checksums for tamper detection
  # - Complete local backup for disaster recovery
  #
  # Recommended for production migrations to catch issues early.
  integrity_verification:
    # Enable integrity verification phase (default: false)
    # When enabled, runs comprehensive checks after fetch and before conversion
    enabled: false
    
    # Halt migration if integrity score falls below threshold (default: false)
    # If true, stops migration when critical issues detected (e.g., >50% missing attachments)
    halt_on_failure: false
    
    # Create complete local backup of fetched content (default: true)
    # Saves raw HTML, metadata, and attachments to backup directory
    create_backup: true
    
    # Backup directory path (default: "./integrity-backup")
    backup_directory: "./integrity-backup"
    
    # Verification depth (default: "standard")
    # Options:
    #   - "basic": Check attachments and hierarchy only
    #   - "standard": Add page checksums and link validation
    #   - "full": Include external link validation (slower)
    verification_depth: "standard"
    
    # Verify external links by checking HTTP status (default: false)
    # Warning: Significantly increases verification time for pages with many external links
    verify_external_links: false
    
    # Compute and store checksums for all content (default: true)
    # SHA256 hashes for pages and attachments, stored in metadata
    compute_checksums: true
    
    # Parallel workers for checksum computation (default: 3)
    # Higher values speed up verification but increase CPU usage
    checksum_workers: 3
    
    # Save verification report to file (default: true)
    save_report: true
    
    # Report output formats (default: ["json", "console"])
    # Options: "json", "console", "csv"
    report_formats:
      - "json"
      - "console"
